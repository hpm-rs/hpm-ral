raltool
=======

`raltool` is a fork of [`chiptool`][], which is itself a fork of [`svd2rust`][].
The register access layer (RAL) generated by `raltool` strives to compile faster
than anything generated by `chiptool` or `svd2rust`, supporting the needs of
Rust projects that work with very large SVDs.

`raltool` is an experiment to support the [`imxrt-ral`][] project. The
tool's interface and features do not vary much from [`chiptool`][], so see
that project's documentation for more information. However, the
`raltool`-generated code is different than both `chiptool`- and
`svd2rust`-generated code. For more information on the `raltool`-generated API,
see the [`imxrt-ral`][] project.

  [`chiptool`]: https://github.com/embassy-rs/chiptool
  [`svd2rust`]: https://github.com/rust-embedded/svd2rust
  [`imxrt-ral`]: https://github.com/imxrt-rs/imxrt-ral

Benchmarks
----------

`svd2rust`, `chiptool`, and `raltool` ingested a patched SVD for an i.MX RT 1062
MCU and generated a Rust crate. The table below shows the `cargo build` build
times for each crate. Each build succeeded without warnings.

| Codegen tool            | Build time |
|:------------------------|:-----------|
| `svd2rust`              | 1m 30s     |
| `chiptool` <sup>1</sup> | 47s        |
| **`raltool`**           | **9s**     |

<sup>1 Lightly modified the generated crate to suppress warnings.</sup>

`svd2rust` version 0.24.1. `chiptool` built at revision `73b33d9`. rustc 1.63.0.

`chiptool` enhancements
-----------------------

             ┌───────┐ IR_A ┌───────────┐ IR_A' ┏━━━━━━━━━┓
    SVD_A -> │ Parse │ ---> │ Transform │ ----> ┃         ┃
             └───────┘      └───────────┘       ┃         ┃
             ┌───────┐ IR_B ┌───────────┐ IR_B' ┃         ┃ IR ┌─────────┐
    SVD_B -> │ Parse │ ---> │ Transform │ ----> ┃ Combine ┃ -> │ Codegen │ -> RAL Crate
             └───────┘      └───────────┘       ┃         ┃    └─────────┘
             ┌───────┐ IR_C ┌───────────┐ IR_C' ┃         ┃
    SVD_C -> │ Parse │ ---> │ Transform │ ----> ┃         ┃
             └───────┘      └───────────┘       ┗━━━━━━━━━┛

`raltool` changes more than just the generated code. `raltool` accepts multiple
SVD files, and introduces a new "combine" phase to the process. The
combine phase consolidates blocks, fieldsets, and enums *across* devices. The
combine pass runs after the transform pass(es), consuming one or more `chiptool`
intermediate representations (IR) to create a new IR. This single, combined IR
represents all the peripherals, blocks, fieldsets, and enums for all devices.
The codegen phase generates modules to represent that combined IR.

In practice, the combine phase can automatically reduce `N` UART peripherals
from `N` SVDs down to 1 UART peripheral. This works even if the input SVDs have
different names for blocks, fieldsets, or enums.

The combine phase is conservative, and it won't combine device elements if
they don't seem equivalent. If you know that blocks, fieldsets, or enums
should be equivalent, you can use transforms to coax the IR into a combine-able
form, or you can patch your SVD(s).

Limitations
-----------

Aliased registers are not supported. To control codegen, use a transform to
remove aliased registers / fields. The codegen phase will select an arbitrary
register alias for codegen, though it prefers an alias that's both
read-write.

Aliased cluster arrays are also not supported. The recommendation is to either
remove the peripherals, or describe the peripherals differently, using
`chiptool` YAML. Surprisingly, aliased cluster arrays appear in practice; see
the i.MX RT 11xx SVDs.

The transform phase(s) run before the combine phase, not after. It's
trivial to introduce a transform phase on the combined IR, but there
hasn't been a need for this.

`raltool` simply generates a tree of Rust source files. It does not generate a
`Cargo.toml` to define the package. You're responsible for defining this
manifest, adding all dependencies, and defining the features expected in the
generated code. `cargo init` and `cargo add` can help with this:

``` bash
cd path/to/output

cargo init
cargo add cortex-m ral-registers

# Edit Cargo.toml, add feature flags for devices.
# See lib.rs for expected features.
```

License
-------

Licensed under either of

- Apache License, Version 2.0 ([LICENSE-APACHE][] or
  http://www.apache.org/licenses/LICENSE-2.0)
- MIT license ([LICENSE-MIT][] or http://opensource.org/licenses/MIT)

at your option.

  [LICENSE-APACHE]: LICENSE-APACHE
  [LICENSE-MIT]: LICENSE-MIT

**Contribution**

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall be
dual licensed as above, without any additional terms or conditions.
